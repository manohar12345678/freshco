<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Chalo ¬∑ FreshCo ‚Äî PLU Lookup</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#c7e21c" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <style>
        /* =========================
           LIGHT THEME ONLY
           ========================= */
        html { color-scheme: light; }               /* prevent auto-darkening on mobile */

        /* =========================
           TOKENS
           ========================= */
        :root{
          --brand-lime:#c7e21c;
          --ink:#0f0f0f;
          --muted:#707070;
          --surface:#ffffff;
          --surface-2:#f5f7f8;
          --border:rgba(0,0,0,.10);
          --radius:14px;
          --tap:48px;

          /* header height (adjust if you resize the logo) */
          --brandbar-h:72px;
        }

        /* =========================
           BASE
           ========================= */
        *, *::before, *::after { box-sizing: border-box; }
        html, body { height: 100%; }
        body{
          margin:0;
          font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
          -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
          background:var(--brand-lime);
          color:var(--ink);

          /* space for the fixed header (search bar is inside the card and sticks) */
          padding-top: var(--brandbar-h);
        }
        img{ max-width:100%; height:auto; display:block; }
        button, input{ font:inherit; }
        .sr-only{
          position:absolute!important; width:1px; height:1px; padding:0; margin:-1px;
          overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
        }
        :focus-visible{ outline:3px solid #7aa7ff; outline-offset:2px; border-radius:10px; }
        @media (prefers-reduced-motion:reduce){
          *{ animation-duration:.001ms!important; animation-iteration-count:1!important; transition-duration:.001ms!important; }
        }

        /* =========================
           FIXED BRAND HEADER (WHITE)
           ========================= */
        .brandbar{
          position:fixed; top:0; left:0; right:0; z-index:9999;
          height:var(--brandbar-h);
          padding: calc(12px + env(safe-area-inset-top, 0px)) 16px 12px;
          background:#fff;                          /* ‚Üê WHITE header */
          color:#111;
          box-shadow:0 1px 0 rgba(0,0,0,.08);       /* subtle divider */
          display:flex; align-items:center; justify-content:center;
        }
        .brandbar__inner{
          height:100%; width:100%;
          display:flex; align-items:center; justify-content:center;
        }
        .brandbar__logo{ display:inline-flex; align-items:center; line-height:0; }
        .brandbar__logo img{ height:64px; width:auto; display:block; } /* try 56‚Äì72px */

        /* =========================
           APP SHELL
           ========================= */
        .appwrap{ max-width:640px; margin:10px auto 22px; padding:12px; }
        .appcard{
          background:var(--surface);
          border-radius:16px;
          box-shadow:0 6px 18px rgba(0,0,0,.12);
          padding:12px;
        }

        /* =========================
           SEARCH (IDs must remain)
           ========================= */
        .bar{
          position:sticky;
          top: var(--brandbar-h);   /* sticks under the fixed header */
          z-index:40;
          background:transparent;
          padding-top:2px;
        }
        .searchwrap{
          display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center;
        }

        /* pill input */
        #query{
          width:100%;
          height:52px;
          border-radius:999px;
          border:1.5px solid var(--border);
          background:#fff;
          padding:0 14px;
          font-size:16px; line-height:1;
          outline:none;
          box-shadow:0 2px 8px rgba(0,0,0,.06);
        }
        #query:focus{ border-color:rgba(0,0,0,.24); }

        /* icon-only button next to input (white) */
        #btn{
          width:44px; height:44px;
          border-radius:999px;
          border:1.5px solid var(--border);
          background:#fff; color:#111;
          display:inline-flex; align-items:center; justify-content:center;
          cursor:pointer;
          box-shadow:0 2px 8px rgba(0,0,0,.06);
          -webkit-tap-highlight-color:transparent;
          font-size:0;                         /* hide button text if any */
        }
        #btn::before{ content:"üîé"; font-size:18px; line-height:1; }
        #btn:active{ transform:scale(.98); }

        /* =========================
           RESULTS (JS fills #results)
           ========================= */
        .result{ margin-top:12px; }
        .result ul{ list-style:none; padding:0; margin:12px 0 0; }
        .result li.card{
          display:grid; grid-template-columns:64px 1fr; gap:10px; align-items:center;
          padding:10px 8px;
          border-radius:14px;
          background:#fff;
          box-shadow:0 1px 0 rgba(0,0,0,.08);
        }
        .result li.card + li.card{ margin-top:10px; }

        .thumb{
          width:64px; height:64px; border-radius:10px;
          object-fit:cover; background:var(--surface-2);
        }

        .meta{ line-height:1.35; font-size:15px; }
        .meta strong{
          display:block; font-weight:900; color:#2b2b2b;
          font-variant-numeric: tabular-nums;   /* PLUs align nicely */
          letter-spacing:.1px;
        }
        .muted, .muted strong{ color:var(--muted); }

        /* Larger phones */
        @media (min-width:420px){
          .appwrap{ padding:16px; }
          .result li.card{ grid-template-columns:72px 1fr; padding:12px; }
          .thumb{ width:72px; height:72px; border-radius:12px; }
        }

        /* === Ensure input text is visible on white background === */
#query{
  background:#fff !important;
  color:#111 !important;          /* typed text */
  caret-color:#111 !important;    /* cursor color */
  -webkit-text-fill-color:#111;    /* Safari/iOS */
}

/* Placeholder color (kept readable but muted) */
#query::placeholder{
  color: var(--muted) !important;  /* e.g. #707070 */
  opacity: 1;                      /* some browsers fade it */
}

/* iOS/Chrome autofill fix: keep white background + dark text */
#query:-webkit-autofill,
#query:-webkit-autofill:hover,
#query:-webkit-autofill:focus{
  -webkit-text-fill-color:#111 !important;
  box-shadow: 0 0 0 1000px #fff inset !important; /* force white fill */
  transition: background-color 9999s ease-out 0s; /* hide yellow flash */
}

/* If your search icon button should stay white with dark icon */
#btn{
  background:#fff !important;
  color:#111 !important;           /* emoji icon inherits this */
  border:1.5px solid var(--border) !important;
}

    </style>
</head>

<body>

<!-- ===== White, centered brand header ===== -->
<header class="brandbar" role="banner" aria-label="Chalo FreshCo">
    <div class="brandbar__inner">
        <a class="brandbar__logo" href="/" aria-label="Home">
            <!-- Swap to your actual logo path (relative, not absolute) -->
            <img src="img/plu/download.png" alt="Chalo ¬∑ FreshCo ‚Äî PLU Lookup">
        </a>
    </div>
</header>

<!-- ===== App Card ===== -->
<main class="appwrap" role="main">
    <section class="appcard" aria-label="PLU search">
        <div class="bar">
            <div class="searchwrap">
                <!-- DO NOT CHANGE THESE IDS (JS relies on them) -->
                <label for="query" class="sr-only">Search item name or PLU</label>
                <input id="query"
                       type="search"
                       placeholder="Search item or PLU (e.g., Banana or 4011)"
                       inputmode="search"
                       enterkeyhint="search"
                       autocapitalize="none"
                       autocomplete="off"
                       aria-describedby="searchHelp" />
                <!-- Icon-only button (your JS already binds to #btn) -->
                <button id="btn" type="button" aria-label="Search"></button>
            </div>
        </div>

        <!-- Results target (your JS fills this) -->
        <div id="results" class="result" aria-live="polite" aria-busy="false">
            <span id="searchHelp" class="muted">Type an item or a PLU to begin.</span>
            <!--
              Your JS will inject:
              <ul>
                <li class="card" aria-label="Banana - No Gas - Green">
                  <img class="thumb" src="img/plu/4011.jpg" alt="Banana - No Gas - Green">
                  <div class="meta"><strong>4011 ‚Äì Banana - No Gas - Green</strong></div>
                </li>
              </ul>
            -->
        </div>
    </section>
</main>




<script>
    /* ======================== CONFIG: IMAGE PATHS ======================== */
    // With your current IntelliJ structure, this works out of the box:
    //   FreshcoPLU/index.html
    //   FreshcoPLU/img/plu/4011.jpg
    // If you later host on GitHub Pages under a repo, the relative path still works.
    // If you move images, just change IMAGE_BASE.

    const IMAGE_BASE = "img/plu/";

    function slugifyName(name){
      return (name || "")
        .toLowerCase()
        .normalize('NFKD').replace(/[\u0300-\u036f]/g,'') // strip accents
        .replace(/[^a-z0-9]+/g,'-')
        .replace(/(^-|-$)/g,'') + ".jpg";
    }

    function imgCandidates(code, name){
      return [ IMAGE_BASE + String(code).trim() + ".jpg", IMAGE_BASE + slugifyName(name) ];
    }


    function placeholderData(text){
      const t = encodeURIComponent((text || "PLU").slice(0, 4).toUpperCase());
      return "data:image/svg+xml;utf8," +
        `<svg xmlns='http://www.w3.org/2000/svg' width='128' height='128'>` +
          `<rect width='100%' height='100%' fill='%23f3f4f6'/>` +
          `<text x='50%' y='55%' text-anchor='middle' dominant-baseline='middle' ` +
                `font-family='system-ui,sans-serif' font-size='34' fill='%239ca3af'>${t}</text>` +
        `</svg>`;
    }

    // Fallback tries alt then placeholder (used by onerror on <img>)
    window.__imgFallback = function(img){
      const alt = img.dataset.alt;
      const ph  = img.dataset.ph;
      if (!img.dataset.try2){
        img.dataset.try2 = "1";
        img.src = alt;
      } else {
        img.onerror = null;
        img.src = ph;
      }
    };

    /* ======================== DATA ======================== */
    // Your PLU map (trimmed example below; keep your full list)
    var pluMap = {
  "8136": "A Choy",
  "3012": "Abate Pears",
  "4750": "Acorn / Pepper",
  "5047": "Almonds - Natural Raw",
  "3064": "Aloe Vera Leaf",
  "3438": "Ambrosia Apples",
  "3176": "Amla / Gooseberry (Loose)",
  "4677": "Anaheim Hot Peppers",
  "4515": "Anise",
  "58854": "Apple Mango",
  "4503": "Arrow Root",
  "4084": "Artichokes Each",
  "4408": "Asian Brown Pears",
  "4407": "Asian Yellow Pears",
  "4080": "Asparagus",
  "4220": "Atemoya",
  "89140": "Avocado 5pk Bag",
  "73618": "Avocado Caribbean",
  "4046": "Avocadoes Loose",
  "8165": "Baby Bok Choy VolFil",
  "8134": "Baby Napa",
  "95704": "Bag for Life Replacement",
  "4011": "Banana - No Gas - Green",
  "23885": "Banana Flower",
  "4237": "Bananas #2‚Äôs",
  "94011": "Bananas Organic",
  "71514": "Bananas Thai",
  "4024": "Bartlett Pears",
  "4885": "Basil Regular",
  "4528": "Beans Fava",
  "4066": "Beans Green",
  "81187": "Beef",
  "4540": "Beets - Bulk",
  "4539": "Beets - Bunch",
  "4065": "Bell Green Sweet Peppers",
  "3121": "Bell Orange Sweet Peppers",
  "4688": "Bell Red Sweet Peppers",
  "4689": "Bell Yellow Sweet Peppers",
  "23742": "Bengali Squash",
  "54525": "Bhindi (Indian Okra)",
  "4783": "Bitter Melon, Chinese",
  "4789": "Bitter Melon, Indian",
  "4039": "Black Plums",
  "4056": "Black Seedless Grapes",
  "4239": "Blackberries (170g)",
  "4527": "Bodie (Long Beans)",
  "4545": "Bok Choy",
  "4026": "Bosc Pears",
  "4632": "Boston Lettuce",
  "4254": "Breadfruit",
  "4471": "Breadnut/Sour",
  "4060": "Broccoli",
  "3082": "Broccoli Crowns",
  "4550": "Brussel Sprouts",
  "9642": "Bulk Peanuts - In Shell",
  "88192": "Burdock",
  "4759": "Butternut",
  "60096": "Cabbage Flat (Kg)",
  "4556": "Cabbage Green (Each)",
  "3254": "Cabbage Red (Each)",
  "4955": "Cabbage Savoy (Each)",
  "48997": "Cactus Prickly Pears - Case",
  "89362": "Calamansi",
  "3189": "Callaloo",
  "4050": "Cantaloupes",
  "4562": "Carrots Bulk",
  "4094": "Carrots Bunch",
  "9750": "Cashews - Raw",
  "4079": "Cauliflower",
  "4583": "Celery",
  "4585": "Celery Root",
  "3178": "Chaapan Kandu",
  "8180": "Chayote",
  "4257": "Cherimoya",
  "4045": "Cherries",
  "80689": "Chicken",
  "71803": "Chickpeas",
  "4686": "Chili Peppers",
  "23920": "Chinese Cauliflower",
  "89388": "Chinese Chestnuts",
  "73479": "Chinese Leek",
  "4820": "Chinese Taro",
  "4888": "Chives",
  "4889": "Cilantro / Coriander",
  "4450": "Clementines (Loose)",
  "49532": "Clementines 2lb",
  "4827": "Cocoes",
  "4261": "Coconut",
  "4614": "Collard",
  "49500": "Comp Lemons 2lb",
  "49511": "Comp Oranges 3lb",
  "49533": "Comp Yellow 3lb",
  "9016": "Compost Cow Manure",
  "9008": "Compost Sheep Manure",
  "73582": "Cooking Papaya",
  "4078": "Corn - Loose",
  "3507": "Cosmic Crisp Apples",
  "4687": "Cubanelle Sweet Peppers",
  "4593": "Cucumber Seedless",
  "4999": "Cucumbers 6pk Mini",
  "4823": "Cucumbers Dill - 3L",
  "4062": "Cucumbers Field",
  "4822": "Curry Leaf",
  "4615": "Dandelion",
  "4791": "Dasheen (Yam)",
  "4511": "Dasheen Bush",
  "4891": "Dill Fresh",
  "3040": "Dragon Fruit / Pitahaya",
  "32942": "Drumstick",
  "23740": "Drumstick Leaves",
  "3182": "Eddoes Costa Rica",
  "47209": "Eddoes Indian",
  "4081": "Eggplant",
  "3089": "Eggplant Chinese",
  "4500": "Eggplant Indian",
  "88149": "Eggplant Philippine",
  "43461": "Eggplant Thai",
  "4854": "Eggplant Trinidadian",
  "4604": "Endive",
  "4543": "Endive Belgium",
  "4605": "Escarole",
  "49465": "Farmyard Compost",
  "4800": "Field Tomatoes",
  "40813": "Field Tomatoes 3L Basket",
  "4418": "Forelle Pears",
  "4474": "Fragrant Pears",
  "4131": "Fuji Apples",
  "4350": "Fuzzy Melon",
  "4916": "Gai Choy Baby",
  "3160": "Gai Lan",
  "8156": "Gai Lan VolFil",
  "4608": "Garlic",
  "88870": "Garlic Stem",
  "40529": "Gawar",
  "4612": "Ginger Root",
  "4021": "Golden Delicious Apples",
  "4243": "Gooseberries 6oz",
  "3038": "Granadilla",
  "4139": "Granny Smith Apples",
  "88844": "Grape Leaves",
  "3216": "Grape Tomatoes",
  "4288": "Grapefruit Deep Red",
  "4068": "Green Onion",
  "4394": "Green Papaya",
  "5597": "Green Plums",
  "4022": "Green Seedless Grapes",
  "88144": "Green Sour Grapes",
  "3283": "Honeycrisp Apples",
  "4329": "Honeydew Melons",
  "4625": "Horseradish Root",
  "4799": "Hothouse Large Tomatoes",
  "4690": "Hungarian Hot Peppers",
  "4061": "Iceberg Lettuce",
  "4480": "Jackfruit",
  "4693": "Jalapeno Hot Peppers",
  "4626": "Jicama",
  "4313": "Julie Mango",
  "4769": "Kabocha",
  "4627": "Kale",
  "3193": "Kale - Red",
  "4030": "Kiwi",
  "72715": "Kiwi Clamshell",
  "4628": "Kohlrabi",
  "4076": "Leaf Green",
  "4075": "Leaf Red",
  "4629": "Leeks",
  "4053": "Lemons",
  "4048": "Limes",
  "54670": "Lobok - Green",
  "88188": "Lobok - With Stem",
  "4001": "Long Squash",
  "4308": "Loquats",
  "3099": "Lotus Root",
  "4309": "Lychee",
  "4644": "Malanga Root",
  "4312": "Mango Ataulfo",
  "3198": "Mango Ataulfo - Case",
  "4311": "Mangoes Green",
  "4051": "Mangoes Red",
  "5006": "Mangoes Sugar",
  "4317": "Melons Canary/Yellow",
  "3623": "Melons Hami",
  "4336": "Melons Santa Claus",
  "8608": "Methi",
  "5885": "Milk Chocolate Almonds",
  "8190": "Mini Baby Bok VolFil",
  "4824": "Mini Cucumber",
  "8195": "Mini Shanghai Bok VolFil",
  "4896": "Mint Fresh",
  "4552": "Napa Cabbage",
  "8016": "Nasberry (Chikoo)",
  "4012": "Navel Oranges",
  "4378": "Nectarines",
  "3035": "Nectarines White",
  "4655": "Okra",
  "4656": "Okra, Chinese",
  "4897": "Oregano",
  "3112": "Papaya Formosa Large",
  "4901": "Parsley Italian",
  "4899": "Parsley Regular",
  "4671": "Parsley Root",
  "54527": "Parwar",
  "4397": "Passion Fruit",
  "25255": "Passion Fruit Yellow",
  "4044": "Peaches",
  "4405": "Peaches 3lt",
  "4401": "Peaches White Flesh",
  "4433": "Pineapples",
  "4128": "Pink Cripps Apples",
  "9760": "Pistachios Salted",
  "4235": "Plantain Bananas",
  "4087": "Plum / Roma Tomatoes",
  "4705": "Poblano Hot Peppers",
  "54220": "Pooja Coconut",
  "63252": "Pork",
  "4279": "Pummelos",
  "4760": "Pumpkin, Jamaican",
  "4447": "Quince",
  "4738": "Radicchio",
  "4089": "Radish Bunch",
  "88972": "Rambutan",
  "4547": "Rapini Andy Boy",
  "4054": "Raspberries (170g)",
  "4565": "Red Carrot",
  "4167": "Red Delicious Apples",
  "21394": "Red Guava",
  "4082": "Red Onions",
  "4664" :"Red on the Vine Tomatoes",
  "3183": "Red Onions - Indian",
  "49534": "Red Onions 3lb",
  "4041": "Red Plums",
  "4073": "Red Potato Loose",
  "4023": "Red Seedless Grapes",
  "4747": "Rhubarb",
  "4640": "Romaine Lettuce",
  "4173": "Royal Gala Apples",
  "4725": "Russet Potatoes Loose",
  "4745": "Rutabagas Waxed",
  "3139": "Savory",
  "4711": "Scotch Bonnet Hot",
  "8153": "Shanghai Bok Choy VolFil",
  "13143": "Sharoni Persimmon Case",
  "88029": "Sliced Pumpkin",
  "4665": "Small Yellow Onions, Bulk",
  "3177": "Snake Gourd",
  "8132": "Snow Pea Tips",
  "14206": "Soda Stream Exchange Credit",
  "3990": "Sorrel",
  "4488": "Sour Sop",
  "4776": "Spaghetti",
  "4093": "Spanish Onions",
  "4895": "Spinach (Poi)",
  "4090": "Spinach Bunch",
  "4513": "Spinach Red",
  "3180": "Spiny Gourd / Kantola",
  "4790": "Sugar Cane",
  "21641": "Sugar Cane - Black",
  "89359": "Sweet Limes",
  "4816": "Sweet Potatoes orange",
  "4818": "Sweet potatoes Purple",
  "4586": "Swiss Chard Green",
  "4587": "Swiss Chard Red",
  "3991": "Taiwan Guava",
  "41964": "Taiwan Okra",
  "4793": "Tamarilo Red",
  "4906": "Tarragon",
  "4720": "Thai chili",
  "4907": "Thyme",
  "4851": "Thyme",
  "4574": "Tinda",
  "4787": "Tindora",
  "4963": "Tomatillos",
  "9018": "Topsoil Black Earth 25L",
  "54726": "Tumeric Amba (White)",
  "4918": "Tumeric Yellow",
  "4812": "Turnip White",
  "3993": "Valor, Loose",
  "3060": "Vegetable Marrow",
  "9323": "Verdulaga",
  "4159": "Vidalia Onions",
  "9605": "Walnut Halves & Pieces",
  "4943": "Walnuts - In Shell",
  "22073": "Water Coconut",

  "4815": "Watercress",
  "3421": "Watermelon Mini Seedless",
  "4031": "Watermelon Seeded",
  "4032": "Watermelon Seedless",
  "42027": "White Guava",
  "4663": "White Onions",
  "4083": "White Potato Loose",
  "9951": "White Potatoes 3L Basket",
  "4731": "White Yams",
  "4592": "Wild Cucumber",
  "4713": "Wiri Peppers",
  "4890": "Ya Pear",
  "4264": "Yellow Dates",
  "4727": "Yellow Potato Loose",
  "3173": "Yellow Yams",
  "4262": "Young Coconut",
  "8210": "Yu Choy VolFil",
  "4819": "Yucca (Cassava)",
  "4067": "Zucchini",
  "4086": "Zucchini Yellow"
};

// 2) Family map: PLU -> [singular, plural] (extend as needed)
var familyMap = {
  // Bananas
  "4011": ["banana", "bananas"],
  "4237": ["banana", "bananas"],
  "4234": ["banana", "bananas"],

  // Apples

  "58854": ["mango", "mangoes"],
  "4131": ["apple", "apples"],
  "3438": ["apple", "apples"],
  "3283": ["apple", "apples"],
  "4173": ["apple", "apples"],
  "4128": ["apple", "apples"],
  "3507": ["apple", "apples"],
  "4139": ["apple", "apples"],
  "4167": ["apple", "apples"],
  "4021": ["apple", "apples"],


  // Melons
  "4032": ["melon", "melons"],
  "4031": ["melon", "melons"],
  "4050": ["melon", "melons"],
  "4329": ["honeydew", "honeydews"],

  // Potatoes
  "4727": ["potato", "potatoes"],
  "4725": ["potato", "potatoes"],
  "4073": ["potato", "potatoes"],
  "4083": ["potato", "potatoes"],


};

    /* ======================== NORMALIZATION / MATCHING (from your earlier JS) ======================== */
    const aliases = {
  "aubergine":"eggplant",
  "brinjal":"eggplant",
  "courgette":"zucchini",
  "capsicum":"pepper",
  "bhindi":"okra",
  "coriander":"cilantro",
  "spring onion":"green onion",
  "scallion":"green onion",
  "bell pepper":"pepper",
  "water melon":"watermelon",
  "bread fruit":"breadfruit",
  "dragon fruit":"dragonfruit",
  "jack fruit":"jackfruit",
  "star fruit":"starfruit",
  "passion fruit":"passionfruit",
  "custard apple":"custardapple"
};
// IMPORTANT: don't include "sweet potato":"sweetpotato"



    const STOP = new Set([
      "the","a","for","code","plu","all","please","give","me","of","find",
      "each","bulk","bunch","case","bag","basket","pack","pk","lb","lbs",
      "kg","g","oz","clamshell","mini","large","small","loose","on","and"
    ]);

    function stripDiacritics(s){
      return (s||"").normalize ? s.normalize("NFD").replace(/[\u0300-\u036f]/g,"") : s;
    }
    function normalize(s){
      return stripDiacritics(String(s||"")).toLowerCase().replace(/[^a-z0-9\s]/g," ").replace(/\s+/g," ").trim();
    }
    const SING_EXCEPT = new Set(["asparagus","citrus","lettuce","bass","glass","chess"]);
    function singularize(w){
      if (!w) return w;
      if (SING_EXCEPT.has(w)) return w;
      if (w.endsWith("ses")) return w.slice(0,-2);
      if (w.endsWith("ies") && w.length>4) return w.slice(0,-3)+"y";
      if (w.endsWith("ss") || w.endsWith("us")) return w;
      if (w.endsWith("s") && w.length>4) return w.slice(0,-1);
      return w;
    }
    function toTokens(s){
      let joined = normalize(s).split(" ").filter(Boolean).map(singularize).filter(t => !STOP.has(t)).join(" ");
      Object.keys(aliases).forEach(k => {
        const nk = normalize(k);
        if (joined.indexOf(nk) !== -1) joined = joined.replace(new RegExp("\\b"+nk+"\\b","g"), normalize(aliases[k]));
      });
      return joined.split(" ").filter(Boolean);
    }
    function soundex(word){
      word = normalize(word); if (!word) return "";
      const first = word[0].toUpperCase();
      const map = { b:1,f:1,p:1,v:1, c:2,g:2,j:2,k:2,q:2,s:2,x:2,z:2, d:3,t:3, l:4, m:5,n:5, r:6 };
      let out = first, prev = map[word[0]] || 0;
      for (let i=1;i<word.length;i++){
        const code = map[word[i]] || 0;
        if (code !== 0 && code !== prev) out += String(code);
        prev = code;
      }
      return (out + "000").slice(0,4);
    }
    function trigrams(s){
      s = "  " + normalize(s) + "  ";
      const g={}; for (let i=0;i<s.length-2;i++) g[s.slice(i,i+3)] = (g[s.slice(i,i+3)]||0)+1;
      return g;
    }
    function cosine3(a,b){
      const A=trigrams(a), B=trigrams(b); let dot=0, na=0, nb=0;
      for (const k in A){ na += A[k]*A[k]; if (B[k]) dot += A[k]*B[k]; }
      for (const k2 in B) nb += B[k2]*B[k2];
      return (na&&nb) ? dot / Math.sqrt(na*nb) : 0;
    }
    function editDistance(a,b){
      a=normalize(a); b=normalize(b); const al=a.length, bl=b.length; if (!al) return bl; if (!bl) return al;
      const dp = new Array((al+1)*(bl+1));
      const idx=(i,j)=>i*(bl+1)+j;
      for (let i=0;i<=al;i++) dp[idx(i,0)]=i;
      for (let j=0;j<=bl;j++) dp[idx(0,j)]=j;
      for (let i=1;i<=al;i++) for (let j=1;j<=bl;j++){
        const cost = a.charAt(i-1)===b.charAt(j-1)?0:1;
        const del=dp[idx(i-1,j)]+1, ins=dp[idx(i,j-1)]+1, sub=dp[idx(i-1,j-1)]+cost;
        dp[idx(i,j)] = Math.min(del, ins, sub);
      }
      return dp[idx(al,bl)];
    }
    function tokenSet(str){ return toTokens(str).reduce((set,t)=> (set[t]=1,set),{}); }
    function phoneticSimilarity(aTokens,bTokens){
      if (!aTokens.length || !bTokens.length) return 0;
      const a=aTokens.map(soundex), b=bTokens.map(soundex); let matches=0;
      for (let i=0;i<a.length;i++) for (let j=0;j<b.length;j++) if (a[i] && a[i]===b[j]) { matches++; break; }
      return matches / Math.max(a.length,b.length);
    }
    function jaccard(aStr,bStr){
      const A=tokenSet(aStr), B=tokenSet(bStr); let inter=0, uni=0; const keys={};
      for (const k in A){ keys[k]=1; if (B[k]) inter++; }
      for (const k2 in B) keys[k2]=1;
      for (const u in keys) uni++;
      return uni ? inter/uni : 0;
    }
    function scoreName(name, query){
      const nameN=normalize(name), qN=normalize(query); if (!nameN||!qN) return 0;
      const sub = nameN.indexOf(qN)!==-1 ? 1 : 0;
      const dist=editDistance(nameN,qN), maxLen=Math.max(nameN.length,qN.length);
      const edSim = maxLen ? (1 - dist/maxLen) : 0;
      const jac = jaccard(name, query);
      const ph  = phoneticSimilarity(toTokens(name), toTokens(query));
      const cos = cosine3(name, query);
      let score = (jac*0.40) + (sub*0.25) + (ph*0.15) + (cos*0.10) + (edSim*0.10);
      if (nameN.startsWith(qN)) score += 0.15;
      return score;
    }
    function nospace(s){ return normalize(s).replace(/\s+/g,""); }
    function equalLoose(a,b){ const an=normalize(a), bn=normalize(b); return (an&&bn&&an===bn) || (nospace(a)===nospace(b)); }
    function scoreNameLoose(name,query){ return Math.max(scoreName(name,query), scoreName(nospace(name), nospace(query))); }

    // Build family helpers

  const FAMILY = (function(){
  const byCode = Object.create(null);
  const toCanonical = Object.create(null);

  Object.keys(familyMap).forEach(code => {
    const arr = familyMap[code];
    if (!Array.isArray(arr) || !arr[0]) return;

    const canonical = normalize(arr[0]);         // e.g., "sweet potato"
    byCode[code] = canonical;

    // Map full phrase
    toCanonical[canonical] = canonical;

    // Map each token of the phrase -> canonical ("sweet","potato" ‚Üí "sweet potato")
    toTokens(canonical).forEach(tok => { toCanonical[tok] = canonical; });

    // Map plural phrase similarly
    if (arr[1]) {
      const plural = normalize(arr[1]);
      toCanonical[plural] = canonical;
      toTokens(plural).forEach(tok => { toCanonical[tok] = canonical; });
    }

    // No-space variant helps with alias-collapsed forms
    const noSpace = canonical.replace(/\s+/g, '');
    toCanonical[noSpace] = canonical;
  });

  return { byCode, toCanonical };
})();


    // Build entries + postings
    const entries = Object.keys(pluMap).map(code=>{
      const name = pluMap[code];
      const nameN = normalize(name);
      const tokens = toTokens(nameN);
      const tokSet = tokens.reduce((o,t)=> (o[t]=1,o),{});
      const sndx = tokens.map(soundex);
      return { code, name, nameN, tokens, tokSet, sndx };
    });

    const POSTINGS = new Map();
    entries.forEach((e,i)=> e.tokens.forEach(t=>{
      if (!POSTINGS.has(t)) POSTINGS.set(t,new Set());
      POSTINGS.get(t).add(i);
    }));


    // Build a quick index from family name -> array of entry indices
    const FAMILY_INDEX = Object.create(null);
    entries.forEach((e, i) => {
    const fam = FAMILY.byCode[e.code];  // only explicit PLU mappings
    if (fam) {
    if (!FAMILY_INDEX[fam]) FAMILY_INDEX[fam] = [];
    FAMILY_INDEX[fam].push(i);
    }
    });


    function overlapCount(aSet,bSet){ let c=0; for (const k in aSet) if (bSet[k]) c++; return c; }
    function fastScore(entry, qStr, qTokens, qTokSet, qSndx){
      const sub = entry.nameN.indexOf(qStr)!==-1 ? 1 : 0;
      const inter = overlapCount(entry.tokSet, qTokSet);
      const uni = Object.keys(entry.tokSet).length + qTokens.length - inter;
      const jac = uni ? (inter/uni) : 0;
      let phMatches=0; for (let i=0;i<entry.sndx.length;i++){ const s=entry.sndx[i]; for (let j=0;j<qSndx.length;j++){ if (s && s===qSndx[j]){ phMatches++; break; } } }
      const ph = qSndx.length ? (phMatches/Math.max(entry.sndx.length, qSndx.length)) : 0;
      const starts = entry.nameN.startsWith(qStr) ? 0.15 : 0;
      return (jac*0.55) + (sub*0.30) + (ph*0.15) + starts;
    }

   function inferFamily(entry){
  // 1) Prefer explicit PLU mapping you set in familyMap
  const byCodeFam = FAMILY.byCode[entry.code];
  if (byCodeFam) return byCodeFam;

  // 2) Fallback: infer from tokens (older behavior)
  for (const t of entry.tokens){
    const canon = FAMILY.toCanonical[t];
    if (canon) return canon;
  }
  return "";
}


    /* ======================== UI: SEARCH & RENDER ======================== */
    const cacheHTML = Object.create(null);

    function renderList(items){
      if (!items.length) return '<div><strong>No results</strong></div>';
      const lis = items.map(item=>{
        const [src1, src2] = imgCandidates(item.code, item.name);
        const ph = placeholderData(item.name);
        return `<li class="card" aria-label="${item.name}">
          <img class="thumb" src="${src1}" alt="${item.name}" loading="lazy" decoding="async"
               data-alt="${src2}" data-ph="${ph}" onerror="__imgFallback(this)">
          <div class="meta"><strong>${item.code} ‚Äì ${item.name}</strong></div>
        </li>`;
      }).join('');
      return `<ul>${lis}</ul>`;
    }

    function lookup(){
      const input = document.getElementById('query').value || '';
      const out = document.getElementById('results');
      out.innerHTML = '';

      const q = normalize(input);
      if (!q){ out.innerHTML = '<span class="muted">Type something to search‚Ä¶</span>'; return; }

      if (cacheHTML[q]){ out.innerHTML = cacheHTML[q]; return; }

      // quick exact match (code or name), spacing-insensitive
      let exact = null;
      for (let i=0;i<entries.length;i++){
        const e = entries[i];
        if (equalLoose(e.code, input) || equalLoose(e.name, input)) { exact = e; break; }
      }

      let html = '';

      // digits-only path (PLU)
      if (/^[0-9]+$/.test(q)){
        if (exact){
          const [src1, src2] = imgCandidates(exact.code, exact.name);
          const ph = placeholderData(exact.name);
          html += `<div class="card">
              <img class="thumb" src="${src1}" alt="${exact.name}" loading="lazy" decoding="async"
                   data-alt="${src2}" data-ph="${ph}" onerror="__imgFallback(this)">
              <div class="meta"><strong>‚úÖ Exact Match: ${exact.code} ‚Äì ${exact.name}</strong></div>
            </div>`;
        } else {
          html += '<div><strong>No exact code match</strong></div>';
        }
        // partial code matches
        const partial = [];
        for (let k=0;k<entries.length;k++){
          const e2 = entries[k];
          if (exact && e2.code === exact.code) continue;
          if (e2.code.indexOf(q) !== -1) partial.push(e2);
        }
        if (partial.length){
          partial.sort((a,b)=> (a.code.indexOf(q)-b.code.indexOf(q)) || a.code.localeCompare(b.code));
          html += `<div class="muted"><strong>Other Related Matches:</strong>${renderList(partial.slice(0,20))}</div>`;
        }
        out.innerHTML = html; cacheHTML[q] = html; return;
      }

      // text path
      const qTokens = toTokens(q);
      const qTokSet = qTokens.reduce((o,t)=> (o[t]=1,o),{});
      const qSndx = qTokens.map(soundex);

      // family terms in query
      const famCanonSet = Object.create(null);
      for (const term of qTokens){ const canon = FAMILY.toCanonical[term]; if (canon) famCanonSet[canon]=1; }
      const hasFam = Object.keys(famCanonSet).length>0;

      // candidate pool
        const candIdx = new Set();
        qTokens.forEach(t => (POSTINGS.get(t) || []).forEach(i => candIdx.add(i)));

        // If user query contains a family term, also include every item explicitly mapped to that family
        if (hasFam) {
          Object.keys(famCanonSet).forEach(fam => {
            const arr = FAMILY_INDEX[fam];
            if (arr) arr.forEach(i => candIdx.add(i));
          });
        }

       const pool = candIdx.size ? Array.from(candIdx).map(i => entries[i]) : entries;

      // fast pass
      const scored = [];
      for (const en of pool){
        if (exact && en.code === exact.code) continue;
        let s = fastScore(en, q, qTokens, qTokSet, qSndx);
        if (hasFam){
          const itemFam = inferFamily(en);
          if (itemFam && famCanonSet[itemFam]) s += 0.6;
        }
        if (/[0-9]/.test(q)){
          const digits = q.replace(/\D/g,'');
          if (digits && en.code.indexOf(digits)!==-1) s = Math.max(s, 0.4);
        }
        if (s >= 0.25) scored.push({ ref: en, s });
      }
      scored.sort((a,b)=> b.s - a.s);
      const top = scored.slice(0,60);
      for (let i=0;i<top.length;i++){
        top[i].s = 0.5*top[i].s + 0.5*scoreNameLoose(top[i].ref.name, input);
      }
      top.sort((a,b)=> b.s - a.s);

      if (!top.length && hasFam){
        const famOnly = [];
        for (const ee of entries){
          const famZ = inferFamily(ee);
          if (famZ && famCanonSet[famZ]) famOnly.push(ee);
        }
        if (famOnly.length){
          html += '<div><strong>No exact code/name match</strong></div>';
          html += `<div class="muted"><strong>By family:</strong>${renderList(famOnly.slice(0,20))}</div>`;
          out.innerHTML = html; cacheHTML[q]=html; return;
        }
      }

      if (exact){
        const [src1, src2] = imgCandidates(exact.code, exact.name);
        const ph = placeholderData(exact.name);
        html += `<div class="card">
            <img class="thumb" src="${src1}" alt="${exact.name}" loading="lazy" decoding="async"
                 data-alt="${src2}" data-ph="${ph}" onerror="__imgFallback(this)">
            <div class="meta"><strong>‚úÖ Exact Match: ${exact.code} ‚Äì ${exact.name}</strong></div>
          </div>`;
      } else {
        html += '<div><strong>No exact code/name match</strong></div>';
      }

      if (top.length){
        const list = top.slice(0,15).map(m=> m.ref);
        html += `<div class="muted"><strong>Other Related Matches:</strong>${renderList(list)}</div>`;
      }

      out.innerHTML = html; cacheHTML[q]=html;
    }



    // --- search-as-you-type (debounced) ---
function debounce(fn, ms){
  let t; return function(...args){ clearTimeout(t); t = setTimeout(() => fn.apply(this, args), ms); };
}

const TYPE_DEBOUNCE_MS = 220;   // 200‚Äì300ms feels good
const MIN_CHARS = 2;            // require ‚â•2 letters; allow any digits

const onType = debounce(() => {
  const val = document.getElementById('query').value.trim();
  // Run immediately for numeric PLUs; otherwise wait for ‚â•2 characters
  if (/^\d+$/.test(val) || val.length >= MIN_CHARS) {
    lookup();
  }
}, TYPE_DEBOUNCE_MS);


    document.getElementById('btn').addEventListener('click', lookup);
    document.getElementById('query').addEventListener('keydown', e => { if (e.key === 'Enter') lookup(); });
    document.getElementById('query').addEventListener('input', onType);   // ‚Üê add this line
    document.getElementById('query').focus();
</script>
</body>
</html>
